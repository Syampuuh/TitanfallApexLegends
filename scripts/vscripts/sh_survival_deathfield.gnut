global function Sh_ArenaDeathField_Init

#if SERVER && DEV
                                       
                                            
                                          
                                        
                                         
                                              
                                                  
                                                
                                                
                                                   
#endif

#if SERVER
                                           

                    
                                                   
                                             
                                           
      

                                  
                                      
                                        
                                                  
                                                        
                                            
                                            
                                          
                                            
                                            
                                               
                                                  
                                                    
                                                          
                                                            
                                                           
                                      
                                            
                                                    
                                          
                                          
                                                    
                                               
                                  
                                                
                                  
                                         
                                  
                                               
                                           
                                          

                                                      
                                                         
                                                          
                                                               
                                                   
                                          
                                                  

                                       

                                                
                                           
#endif

#if CLIENT
global function Cl_Deathfield_GetRadiusScale
global function Cl_Deathfield_GetFXIDForRadius
#if DEV
global function Cl_Deathfield_SetOpacityOverride
#endif
global function Cl_GetDeathFieldStage
global function Cl_SURVIVAL_GetDeathField
global function Cl_SURVIVAL_GetDeathFieldCurrentRadius
global function Cl_SURVIVAL_GetDeathFieldCenter
global function ServerCallback_UpdateSurveyBeaconHUDVisibility
global function ServerCallback_SurveyBeaconNotifications
global function SURVIVAL_AddCallback_OnDeathFieldStartShrink
global function SURVIVAL_AddCallback_OnDeathFieldStopShrink
global function UpdateSurveyBeaconHint
global function SurveyBeacon_ShowSquadInfo
#endif

global function HasDeathFieldImmunity
global function SURVIVAL_GetCurrentDeathFieldStage
global function SURVIVAL_GetCurrentRoundString
global function SURVIVAL_IsFinalDeathFieldStage
global function Survival_GetNumDeathfieldStages

global function AddCallback_OnSurvivalDeathFieldStageChanged
global function RemoveCallback_OnSurvivalDeathFieldStageChanged

                    
global function ReconClassCharacter_PassiveChanged
      

global function HasActiveSurveyZone
global function TeamHasActiveSurveyZone

#if CLIENT
table < float, string > distanceToSound =
{
	[ 17000.0 ] = "Survival_Circle_Edge_Large",
	[ 4000.0 ] = "Survival_Circle_Edge_Medium",
	[ 0.0 ] = "Survival_Circle_Edge_Small",
}
#endif

const asset DEATHFIELD_EFFECT = $"P_ring_FP_hit_01"
const string COLOR_CORRECTION = "materials/correction/outside_ring.raw_hdr"

const string DESIGNER_PLACED_CIRCLE_END_SCRIPT_NAME = "circle_end_location_override"
const string DESIGNER_PLACED_CIRCLE_END_RADIUS_NAME = "selection_radius"

const string DESIGNER_PLACED_CIRCLE_END_PLAYLIST_VAR = "sur_circle_end_on_designer_placed_node"
const string DESIGNER_PLACED_TARGET_END_PLAYLIST_VAR = "sur_circle_end_on_target_name"
const string CIRCLE_END_OVERRIDE_PLAYLIST_VAR = "sur_circle_end_override"

global const float REALBIG_CIRCLE_END_RADIUS = 85000
global const float REALBIG_CIRCLE_END_RADIUS_SQ = REALBIG_CIRCLE_END_RADIUS * REALBIG_CIRCLE_END_RADIUS

global const float REALBIG_CIRCLE_END_RADIUS_SMALL_INNER = 30000
global const float REALBIG_CIRCLE_END_RADIUS_SMALL_OUTER = 40000

global const float DEATHFIELD_DAMAGE_CHECK_STEP_TIME = 1.5
global const string FINAL_ROUND_ALIAS_SUFFIX = "Final"

global const float PERSIST_TIME_OUTSIDE_CIRCLE_DEFAULT = 30.0
global const float PERSIST_TIME_OUTSIDE_CIRCLE_LONG = 9999.0

global const string NV_OBSERVER_SURVERY_RING_ENABLED = "PrivateMatch_Observer_SurveyRingEnabled"

global enum ePathfinderNotifications
{
	TEAM_SUCCESS
	NOT_PATHFINDER
	ALREADY_USED
	ALREADY_ACTIVE
}

const float START_WAIT_TIME = 5.0
const float MARGIN_WAIT_TIME = 5.0
const asset SURVEY_BEACON_MODEL = $"mdl/props/pathfinder_beacon_radar/pathfinder_beacon_radar_animated.rmdl"
#if DEV
const string DUMMY_ZONE_WP_NAME = "dev_dummy_circle"
#endif

global struct DeathFieldData
{
	vector center = <0, 0, 0>
	vector nextCenter = <0, 0, 0>

	float currentRadius = 40000.0
	float startRadius = 40000.0
	float endRadius = 40000.0
	float startTime = 10.0
	float endTime = 30.0

	int codeIndex = 0
	float percentDamagePerTick = 0.2
	bool s_deathFieldSynchronized = false
}

global struct DeathFieldStageData
{
	float  endRadius
	float  shrinkDuration
	float  preShrinkDuration
	float  percentDamagePerTick = 0.2
	float  circleDeviation = 1.0
	float  minimapZoomScale = -1.0

	#if SERVER
	             
	#endif
}

#if SERVER
                    
 
	         
	                                  
 
#endif

                    
struct SurveyBeaconData
{
	int passiveSource
	bool functionref( entity, entity  ) canUseFunc
	void functionref( entity, entity ) successFunc
	string calloutLine

	#if SERVER
	                    
	#endif
}
      

struct
{
	#if SERVER
		                                                                  
		                                                                 
		                   							                   
		                                                                                                
		                                                                                               
		                                                         
		                                                       
		                                                   
		                                                 

		                                      
		                       
		                                        

		                          
		                            
		                              
		       
			                                    
		      
	#endif

                     
		table< entity, SurveyBeaconData > surveyBeaconData
       

	array<DeathFieldStageData> deathFieldStageData

	float					   	overrideStartRadius = -1
	array<float>			   	deathFieldStagesOverrideRadius
	array<float>			   	deathFieldStagesOverrideMinimapZoom
	int                        	deathFieldStartStage
	array<entity>               surveyMinimapEnts
	entity                      observerSurveyMinimapEnt
	array<entity>               surveyBeacons

	#if CLIENT
		entity deathField
		entity safeZone
		array< void functionref ( DeathFieldStageData ) > ClientCallbacks_OnDeathFieldStartShrink
		array< void functionref ( DeathFieldStageData ) > ClientCallbacks_OnDeathFieldStopShrink
		int                                               colorCorrection
		float                                             nextHolsterHintTime
		bool											  trackingObserverDeathfield
		int												  fieldEffectHandle
		float 											  ringOpacityOverrideValue
	#endif

	array<void functionref( int stage, float nextCircleStartTime )> onSurvivalDeathFieldStageChangedCallbacks

	bool usePreciseRingFx
	bool ringOpacityOverrideEnabled

} file

void function Sh_ArenaDeathField_Init()
{
	PrecacheParticleSystem( $"P_survival_radius_CP_1x1" )
	PrecacheParticleSystem( $"P_survival_radius_CP_1x5" )
	PrecacheParticleSystem( $"P_survival_radius_CP_1x100" )

	PrecacheParticleSystem( $"P_survival_radius_CP_1k_x_1k" )
	PrecacheParticleSystem( $"P_survival_radius_CP_1k_x_5k" )
	PrecacheParticleSystem( $"P_survival_radius_CP_1k_x_100k" )

	PrecacheParticleSystem( $"P_ring_radCP1_opaCP2_1k_x_1k" )
	PrecacheParticleSystem( $"P_ring_radCP1_opaCP2_1k_x_5k" )
	PrecacheParticleSystem( $"P_ring_radCP1_opaCP2_1k_x_100k" )

                     
		AddCallback_OnPassiveChanged( ePassives.PAS_PATHFINDER, ReconClassCharacter_PassiveChanged )
		AddCallback_OnPassiveChanged( ePassives.PAS_TRACKING_VISION, ReconClassCharacter_PassiveChanged )
		AddCallback_OnPassiveChanged( ePassives.PAS_CRYPTO, ReconClassCharacter_PassiveChanged )
		AddCallback_OnPassiveChanged( ePassives.PAS_VALK, ReconClassCharacter_PassiveChanged )
		AddCallback_OnPassiveChanged( ePassives.PAS_PARIAH, ReconClassCharacter_PassiveChanged )
                 
			AddCallback_OnPassiveChanged( ePassives.PAS_VANTAGE, ReconClassCharacter_PassiveChanged )
        
       

              
                                                                           
       

	file.usePreciseRingFx = GetCurrentPlaylistVarBool( "deathfield_usePreciseRingFx", true )

	file.ringOpacityOverrideEnabled = GetCurrentPlaylistVarBool( "deathfield_ringOpacityOverrideEnabled", true )
	if ( file.ringOpacityOverrideEnabled )
	{
		RegisterNetworkedVariable( "ringOpacityOverride", SNDC_GLOBAL, SNVT_FLOAT_RANGE, 1.0, 0.0, 1.0 )
	}

	PrecacheParticleSystem( $"P_ring_FP_hit_01" )

	RegisterSignal( "NewDeathFieldStarting" )
	RegisterSignal( "UpdateSurveyBeaconVisibility" )

	#if SERVER
		                                          
		                                        

		                                           
		                                         
		                                                                                             
		                                            
		                                     
		                                         
		                                           

		                                                         
		                                                                                  
		                                                                       

		                                                                                                       
		                                                                                                      

		                                                                                     
		                                
		                              

		                                                                                              
	#endif

	InitDeathFieldDataAndStageData()

	#if CLIENT
		file.colorCorrection = ColorCorrection_Register( COLOR_CORRECTION )

		AddCreateCallback( "script_mover", OnPropScriptCreated )
		AddCreateCallback( "prop_script", OnPropScriptCreated )
		AddCreateCallback( "prop_dynamic", OnPropDynamicCreated )
		AddCallback_PlayerClassChanged( SurveyBeaon_ClassChanged )

		AddCallback_OnViewPlayerChanged( OnViewPlayerChanged )

		AddCreatePilotCockpitCallback( TrackDeathfieldDistance )
		AddLocalPlayerTookDamageTypeCallback( eDamageSourceId.deathField, Callback_OnPlayerTakeDeathFieldDamage )
		#if DEV
			Waypoints_RegisterCustomType( DUMMY_ZONE_WP_NAME, DEV_OnDummyCircleWpInstanced )
		#endif

		                                                                                         
		                                             
		                                                                               
		                                            
		                                            
		                                                  
		                                 
		                             
		                                                                    
		                                                
		                                       
		                         
		                                                                                                                                                                        

		RegisterMinimapPackage( "prop_script", eMinimapObject_prop_script.SURVEY_BEACON, MINIMAP_OBJECT_RUI, MinimapPackage_SurveyBeacon, FULLMAP_OBJECT_RUI, FullmapPackage_SurveyBeacon )

		if ( GetCurrentPlaylistVarBool( "deathfield_sound_override", false ) )
		{
			distanceToSound.clear()
			int idx = 0
			float lastDist = 0
			while ( GetCurrentPlaylistVarString( "deathfield_sound_override_stage_" + idx, "" ) != "" )
			{
				string override = GetCurrentPlaylistVarString( "deathfield_sound_override_stage_" + idx, "" )
				array<string> tokens = split( override, ":" )

				Assert( tokens.len() == 2 )
				float dist = float( tokens[0] )
				string audio = tokens[1]

				if ( idx > 0 )
				{
					Assert( dist < lastDist )
				}

				lastDist = dist
				distanceToSound[ dist ] <- audio
				idx++
			}

			Assert( distanceToSound.len() > 0 )
		}

		if ( GetCurrentPlaylistVarBool( "deathfield_opacity_override", true ) )
		{
			if ( GetCurrentPlaylistVarFloat( "deathfield_ringOpacityOverrideValue", 1.0 ) != 1.0 )
			{
				file.ringOpacityOverrideValue = GetCurrentPlaylistVarFloat( "deathfield_ringOpacityOverrideValue", 1.0 )
			}
			else
			{
				RegisterNetworkedVariableChangeCallback_float ( "ringOpacityOverride", Cl_Deathfield_SetOpacityOverride )
			}
		}

	#endif
}


void function GenerateDeathFieldStageData()
{
	file.deathFieldStageData.clear()

	int i = 0
	while ( 1 )
	{
		float radius = GetCurrentPlaylistVarFloat( "deathfield_radius_" + i, -1.0 )

		bool allowMissingDefaults = false
		if ( radius < 0 )
		{
			if ( file.deathFieldStageData.len() > 0 )
			{
				break
			}
			else
			{
				Warning( "Survival deathfield playlist vars are missing!" )
				allowMissingDefaults = true
			}
		}

		file.deathFieldStageData.append( CreateDeathFieldStageData( i++, allowMissingDefaults ) )
	}
}


DeathFieldStageData function CreateDeathFieldStageData( int index, bool allowMissingDefaults )
{
	float lastRadius = SURVIVAL_Deathfield_GetStartRadius()

	if ( file.deathFieldStageData.len() > 0 )
	{
		lastRadius = file.deathFieldStageData[ file.deathFieldStageData.len() - 1 ].endRadius
	}

	bool circleDebug = GetBugReproNum() == 1001

	int currentIndex = file.deathFieldStageData.len()

	float defaultSpeed     = GetCurrentPlaylistVarFloat( "deathfield_default_shrinkSpeed", 140.0 )
	float shrinkSpeed      = GetCurrentPlaylistVarFloat( "deathfield_shrinkSpeed_" + index, -1.0 )
	float circleCloseSpeed = shrinkSpeed > 0 ? shrinkSpeed : defaultSpeed              

	DeathFieldStageData data
	data.circleDeviation = GetCurrentPlaylistVarFloat( "deathfield_circleDeviation_" + index, 1.0 )

	if( index < file.deathFieldStagesOverrideRadius.len() )
		data.endRadius = file.deathFieldStagesOverrideRadius[ index ]
	else
		data.endRadius = GetCurrentPlaylistVarFloat( "deathfield_radius_" + index, allowMissingDefaults ? 20000.0 : -1.0 )

	if( index < file.deathFieldStagesOverrideMinimapZoom.len() )
		data.minimapZoomScale = file.deathFieldStagesOverrideMinimapZoom[ index ]
	else if( data.endRadius <= 600 )
		data.minimapZoomScale = 0.1
	else if ( data.endRadius <= 1000 )
		data.minimapZoomScale = 0.7
	else if ( data.endRadius <= 2000 )
		data.minimapZoomScale = 1.5
	else if ( data.endRadius <= 5000 )
		data.minimapZoomScale =  3.0

	data.preShrinkDuration = GetCurrentPlaylistVarFloat( "deathfield_preShrinkDuration_" + index, allowMissingDefaults ? 240.0 : -1.0 )
	data.shrinkDuration = ((lastRadius - data.endRadius) / circleCloseSpeed)
	data.percentDamagePerTick = GetCurrentPlaylistVarFloat( "deathfield_damagePercent_" + index, allowMissingDefaults ? 0.01 : -1.0 )

	Assert( data.endRadius > 0 )
	Assert( data.preShrinkDuration > 0 )
	Assert( data.shrinkDuration > 0 )
	Assert( data.percentDamagePerTick >= 0 )

	if ( circleDebug )
	{
		data.preShrinkDuration = 10.0
	}

	return data
}


void function InitDeathFieldDataAndStageData()
{
	file.deathFieldStartStage = 0

	GenerateDeathFieldStageData()

	file.deathFieldStartStage = GetCurrentPlaylistVarInt( "survival_death_field_start_stage", 0 )
	if ( file.deathFieldStartStage >= file.deathFieldStageData.len() )
		file.deathFieldStartStage = file.deathFieldStageData.len()
}


float function SURVIVAL_Deathfield_GetStartRadius()
{
	float startRadius = GetCurrentPlaylistVarFloat( "survival_death_field_start_radius", 65000 )

	if ( file.deathFieldStartStage > 0 )
	{
		startRadius = file.deathFieldStageData[file.deathFieldStartStage - 1].endRadius
	}
	else if (file.overrideStartRadius > 0)
	{
		startRadius = file.overrideStartRadius
	}

	return startRadius
}

bool function TeamShouldSeeBeaconMarker( int team )
{
	array<entity> players = GetPlayerArrayOfTeam( team )

	bool shouldSee = false

	foreach ( player in players )
	{
		if ( HasActiveSurveyZone( player ) )
			return false

		if ( PlayerShouldSeeSurveyBeaconMarkers( player ) && !HasActiveSurveyZone( player ) )
			shouldSee = true
	}

	return shouldSee
}

                    
bool function PlayerShouldSeeSurveyBeaconMarkers( entity player )
{
	return player in file.surveyBeaconData || player.GetTeam() == TEAM_SPECTATOR
}
      


#if SERVER
                                          
 
	                          
 

                                 
 
	              

	                                        
		                                

	                                    
		                              

	                           

	                                                       
	                           
	                             
	         

	                           
	 
		                   

		                                                       
		                                                         
		                                                     
		                    

		                                    


		                                    
		                                          
		 
			                            
		 
		                                           
	 

	                                    
	 
		                           
		 
			                                                                                                        
		 
		                                                      
	 

	                              

	                                          
 

                                            
 
	                                                          

	                              
	 
		                                                  
		                                                  
		                                                                                      

		                                                                                 
		                                                                           
			                                                    
		    
			                        

		                            

		                                       
		 
			                                             
			                        
		 
	 
 

                                                                       
 
	                                              
 

                                                     
 
	                                              
	                 
		                

	                                                                
	                
 

#endif          


#if SERVER
                                                                             
 
	                                       
 

                                                                       
 
	                                                         
	                                 
 

                                                                              
 
	                                                 
 

                                                                                   
 
	                                                      
 

                                     
                                                                                        
 
	                                   

	                                                  
	                                    
		      

	                                    

	            
		                     
		 
			                                                                         
		 
	 

	           
	 
		                                                                                                                  
		           
	 
 

                                                                                                                         
 
	                                                                                                                                                                                  
	                                                                   
 

                                                                                                                        
 
	                                                                                                                                                                                
	                                                                  
 

                                                    
 
	       
		                                                     
	      

	             
 


                                                                                                      
 
	       
		                                                     
	      

	                                            
	 
		                              
		            
			                              
			 
				                             
			 
		 
	 

	                                             
	                                                                                                                   
		                

	                                                               

	                          
	 
		           
		                                            
		 
			                                             
			                                                                                                                                                       
		 
	 

	                                            
	                                                                                                                  
		                
 

                                                                                                
 
	                                          
	                                                      
	                    
	                      
	                                  
	                                                                                             
	                       
	                          
	              
	          
	                        
	                                                                  
	                                   
	                          
	                                  
	                                                                       
	                         
	                       
	                                
	                    
	          
 
                                                                            
 
	                                                               
 

                                                                                   
 
	                                                                      
 

                                                                 
 
	                                                                       
 

                                           
 
	                                       
		      

	                                                                                      
	                                                                             
	                                                       

	                                                          

	                                                                               
		                               
	    
		                              

	                                                                                                        
		                                                  

	                                   
	                                    

	                          

	                              

	                              
	 
		                                                  
		                                                  
		                                               
		                           
	 


	                              

	                              
	 
		                                                  

		                                                  
		                                                             
		                                     
		                           
		                             
		                                         
		                       
		                                   
		                                 
		                     
		                 
		                               
		                                        
		                                
		                              
		                                         
		                                  
	 

	                              
	 
		                                                  

		               
		                                                                                             
		                         
		 
			                                                                      
		 
		    
		 
			                                                                             
		 
		                                  

		                                                                              
		                                                       
	 

	                              

	                                                                     
	 
		                        

		                                            
		 
			                                                  
			                                                  
		 
	 

	                                   

	                                                                                                                            
	 
		                                   

		                            
		                                  

		                              
		 
			                                                  
			                              

			                                                  
			                                  
			                                        
		 

		                                            
		                                                                                                  

		                                    
		 
			                         
			 
				                        

				                                            
				 
					                                                  
					                                                  
				 
			 
		 

		                                            
		 
			                                                                           
			                                                                           

			                                                  
			                                                              

			                                                                                                                  
				                                        

			                                                    
			                                 
			                                
		 

		                                                               
		                                                                       

		                                                                                                     
			                                                                

		                                            
		 
			                                        
			                                                  

			                                                         
			 
				                                         
				 
					                                        
				 
				    
				 
					                                  
				 
			 
			                                     

			                                             
			                                      
			                                                
		 

		                                                   

		                      
		 
			                                                                                  
			                                                         

			                                                                    

                             
				                               
				 
					                                                                                        

					                                                               
					 
						                                          
						                                                                            
						                                                    
					 
				 
				    
         
				 
					                                        
					                                                                                                                  
						                                  

					                                           
				 


			                                                                                                         
			       
				                                                               
				 
					                          
					                                          
					                                                                            
					                                                    
				 
			      
		 

		                                   

		                              
		                              
		 
			                                                                           
			                                                             
			                                                  

			                                                      
		 

		                           
		 
			                                                              
		 
		                                                         
		 
			                                   
				                                                                    
			    
				                                                                          
		 
		    
		 
			                                                              
		 

		                                            
		 
			                                                                               
		 

		                     

		                                    

		                         
		 
			                        

			                                            
			 
				                                                  
				                                                  
			 
		 

		                                 
		                                            
		 
			                                                  
			                                                                           

			                                                                               

			                                                                                                         
			                                        

			                                                                        
		 

		                                 
		                                                                                                                     

		                                                                    

		                                            
		 
			                                                  

			                                   
			                           
			                                               
			                                    
		 

		                                                                                                         
		       
			                                                                                                                                                          
			 
				                                                                                                                                                                                                      
			 
		      

		                                            
		 
			                                                  
			                                                                           

			                                                                                   

			                                                               
			 
				                                                                                 
				                                                                             
				                                                                                                  
			 

			                                     
			 
				                                        
				                                 
					                                                                       
			 
		 

		                                      

		        

		                                        
			                                                                         

		                                 

		                                       

		                                   
	 

	                                            
	 
		                                                  
		                                                                                                            
		                                                                        
		                             
			                        
	 

	             
 

                                                                                          
 
	                           
	                                           
	                                                           

	                                      

	                                   
 

                                                                                   
 
	                                              
		      

	                                                  
	                                                     

	                                                           
	                                                                         

	                           
	                           

	                              
	 
		                       
		 
			                                
				        

			                                                              
			 
				           
			 
			                                          
			 
				               
				           
			 
		 
	 

	                       

	                        
	 
		                      
		 
			                               
				        

			                                                 

			                           
			                   
			 
				                                                
				 
					                                              
				 
			 

			                                                                                                        
			 
				              
			 
			                                          
			 
				               
				           
			 
		 
	 
 

       
                      
                                                   
 
	                                                          
	                            
	                                  

	                              
	 
		                                                  
		                               
		                              

		                                  
		                                        
	 

	                                        
		                                                                                           
 

                                                                                                     
 
	                                                          

	                                                                         

	                        
	 
		                      
		 
			                               
				        

			                                                             
			 
				              
			 
		 
	 
 
      

                                      
 
	                   
		           

	                                                                                                                  
		           

	            
 

                                                                        
 
	                                   

	                                  
	 
		                                        

		                                            
		 
			                                            
				        

			                                      
				        

			                                 
			                                                                                                            
				        

			                                                                
			                                 
				                                                                                                                                                                                                          
		 

		                                       
		 
			                        
				        

			                                           
				        

			                                                                         
				        

			                                                         
			                           
			 
				                               
				                                                                                                       
					                                               
			 
			    
			 
				                                 
			 
		 

		                                                       
		 
			                            
				        

			                                               
				        

			                                              
				        

			                                                                             
				        

			                                                      
			                                                  

			                                           
				        

			                                             

			                           
			 
				                                            

				                            
				 
					                                   
					                                                                                                             
					 
						                                      
						                                               
					 
				 
			 
			    
			 
				                                     
			 
		 

		                                  
		 
			                                                                  
			 
				                             
					        

				                                                
					        

				                                                              

				                           
				 
					                    
				 
			 

			                                                                                                         
			                              
			 
				                                                                     
				 
					                             
						        

					                                                
						        

					                                                              

					                           
					 
						                                                
						                                
							        

						                                    
						                                                                                                          
							                                                 
					 
				 
			 
		 

		                                       
		 
			                                         
				        

			                                         
				        

			                                   
				        

			                                                          
			                              
				                                                                                                                                                                                                    
		 

		                                      
	 
 

                                                                                
 
	                     
		      

	                                                 
	                     
	 
		                                                                                
		      
	 
	                                       
	 
		                                                                           
		      
	 

	                                
	                                
	                               

	       
		                                            
	      
 

       
                                                          
 
	                                                
	 
		                                                         
		      
	 
	                                                
 

                        
 
	                    
	                    
 


                                                                                                                                                                                                                            
 
	                                             
	                    

	                                    

	                                       
	                                  

	                           
	                                         
	 
		                              
	 

	                                      

	                                 
	 
		                                       
		                                

		                
		 
			                          
			                         
			                         

			    
			                                          
			                                       
				 
			 
				                                      
				                                                        
					                                                   

				                                                   
			 
		 

		                      
			                                                      
		              

		                              
		                                                               
		                                                                                                
		                              

		                  
			           
		    
			             
	 

	                      

	                           
	                          
	                       

	                                     
	 
		                                     
		 
			                               
			                
			 
				                                                         
				                               
					                        
				                              
					                       

				                 
			 
		 
	 

	                                                                 

	                                          
	                                            

	                                     
	 
		                                     
		 
			                               
			                
			 
				                                                         
				                                                                                                             
				                                   

				                                                                                      
				                                                   

				                                                                          
				                                                                                                                                             
				                                                                                                                                               
				                                                                                                                                               
				                                                                                                                                             

				                                                               
					                                                    

				                                                   
				 
					                                                                                            
					                                                                                  
				 
			 
		 
	 

	                                       	                                                
	 
		         
		                                   
		 
			                     
				                                                                                                  

			                     
				                                                                                                           

			   
		 
	 
 

                                        
 
	                                      
	                                                           
	                                                           

	                                
 

                                                                                                                                                                            
 
	                                             
	                                       

	                                       
	                                            
	                                
	                                     
	 
		                               
		                       
			                
		                            
			                

		                       
			                
		                            
			                
	 

	                                                                          
	                                            
	                                            
	                                                                  
	                                                   

	                                                                                        
	                                                                                        
	                                                                                        
	                                                                                        
	                                                                    
	                                                                 

	                                                                                                                      
	                                                                                                        
	                                                                                                         

	                               
	                                                         
	                                                    
	                       
	                         
	                                 
	 
		                                                
		                       

		                                   
		 
			                         
			           
		 
	 

	                                                       
	                         
	                                 
	 
		                                                 
		                                                                                  
		                       

		                                   
		 
			                         
			           
		 
	 

	                      
	                                                
	                         
	                                                      
	                          
	                             
	                      
	                                   
	                                 
	 
		                              
		                                    
		                                 
		 
			             
				        

			                              

			                                                        
			 
				                               
				                                                             
				 
					                                                      
					                             
				 
			 
		 
		                                                          
	 

	                         
	                                          
	                                                                                 
	                                 
	 
		                                                                                                                  

		                                                                                     
			        


		                                                                                                    
		                                                                         
		                                                                                     
		                                                                       

		                                     
		                                                                               

		                                                                                                   
		                                                                                                   

		                              

		                                                                                                               
		                                      
		                                         
		                                                                                              

		                        
		 
			                    
			                                   
		 

		                                                                                    
		                                                                          
		                                                                                      

		                                                                                                                                        
		                       
		                                  
		 
			                         
			           
		 
	 


	                              
	                                                          
	                         
	                                                              
	                                        
	                                                          
	                                                                                        
	                             
	 
		                                                                         
		                                                                        
		                                      
	 

	                                        
	                                                             
	                                                          
	         		                                        
	                   
	                                          
	 
		                                                                           
		         		                                                                                                                                                                                                           
	 
 

                                                                                                              
 
	                                                                                                
	                                                                                           

	                 
	                         
	 
		                             
			               
		    
			     
	 

	                                                   
	                                                                                                                                                    
	                                                     

	                                                                    
	                               
	                       
	 
		                
		       
			               
			                                 
			     
		                  

		       
			                                           
			               
			     
		                

		       
			               
			                                 
			     
		               

		       
			                                           
			               
			     
		                  

		       
			               
			                                 
			     
	 

	                                    
 

                                                                        
 
	                                                                  

	                   
	 
		                                                                  
		                                                                                
		      
	 

	                                                                      
	 
		                                                             
		                                                                                
	 
 

                                         
 
	         
	                                                    
		                                                                                      
 

                                                         
 
	                                                                                           
	                       

	         
	                                                    
	 
		                 
		 
			                                                                                                
			                       
			     
		 
		   
	 
 

                                                                  
 
	                                                         
 

                                                                    
 
	                       

	         
	                                                    
	 
		                                                                                              
		                       

		          
	 
 

                                                                      
 
	                                                    
	 
		                                                       

		                   
		                                
		                                      
		                                 

		                                      
	 
 

                                                
 
	                                                            
	 
		                             
	 
 

            

                                           
 
	                                         
	 
		             
	 

	                              
 

                                                                         
                                          
 
	                             
	                                
	                                     
 

                                              
 
	                                                                              
	                                                       
	                           
	 
		                   
		                                    					             
		                                        				                 
		                                           			                    
		                                         			                  
		                                       				                
		                                      	 			                
		                                     				              
		                                                  	                           

		                                      

		                               
		 
			                                          
			 
				                                  
			 
		 

		                             
		 
			                                        
			 
				                                
			 
		 
	 

	                                
	                                             
 

                                                   
 
	                                            
	                                             

	                                
	                            
 


                                                                
 
	                                                                                                 
	                                                                                                          
	                                        
	 
		                                                                          
		 
			                  

			                                                            
				                                                                               

			                                                       
		 
		              
	 
 

                                                                                                                  
 
	                           
	 
		                                                 
		                                          
	 

	                                             
 

                                                                                     
 
	                                                          
		                                                    
 

                                         
 
	                                                                                  
	 
		                                                                                             
		                                  
		 
			                                                     
			                        
			 
				                                                                        
				                                                   
			 
		 
		    
		 
			                                                  
		 
	 

	                    
	                                                   
	                                              

	                                                                                  
 

                                  
 
	                                            
	                                
	                                     
	 
		                               
		                       
			                
		                            
			                

		                       
			                
		                            
			                
	 

	                                                                              

	                     		                       
	                     		                       
	                                                                         
	                               	                                 
 

                     
                     

                                            
 
	                                             
	                                                    

	               
	                      

	                                          
	 
		                                                     
		                                                                      
		                   

		                 
		                                                                    
		 
			                       
			 
				                   
				                                                                      
				                                                                                           
				                   
				                                        
				 
					                  
						                 
					    
						                                               
					                                                                                                              
					 
						                                         
						                
						                                                             
						     
					 
				 
				     
			 
			   
		 

		                 
		 
			                                                                                               

			                                                                       
			 
				                     
			 
			    
			 
				                                    
				                                          
			 
			                
		 
	 

	                 
	 
		                                                                                                
		 
			                                                

			                          		                                                          
			 
				                    
			 
			    
			 
				                        

				                                                                                             
			 

		 
		    
		 
			                         
			                                              

			                                                                                                                      
			                               
				                                                                   
			    
				                                                                               
		 
	 

	                    
	                                              
	 
		                                            
	 
	    
	 
		                               

		                                                                                                            
		 
			                   

			                                                                                     
			 
				                                                                    
			 
			    
			 
				                       
			 

			                                                                                                                             
			 
				                                                                                             
				                                                     
				                                                                                                        
				                                                                    
				                                                  

				                 
				                      
				                                                                                                                       
				                                                                                   
				              
				 
					                                                                    
					                                                                  
					                                                                                                         

					                                                
					 
						               

						                                     
						 
							                                     
								                                                                  

							     
						 
						    
						 
							                                     
								                                                              

							                                                                                                                                                        
							                                                                                                                  

							        
						 
					 
					    
					 
						                                     
							                                                               

						     
					 
				 
			 

			                                             
				                                                  

			                      
			                     
			                                        

			                                                    
			                                    

			                                                                 
			                                                                                             
			 
				                                                   
				 
					                         
					                          
				 
			 

			                                                  
			 
				                                                                  
				                                                
				                                                 

				                                                    

				                                                   
				 
					                         
					                          
					     
				 

				       
			 
		 

		                          
		 
			                                                                           
			                                                             
		 
	 

	                    
 

                                                                           
 
	                                                    
	                                                       

	                                           
	                              

	                                                                                                                                 
	                                                                                                                                 

	                    
	                                                               
	 
		                                                      

		                                                                                                                   
		                                                                                                           
		                                                                                                                            
		                                                                         
		                                                                                                                     
		                                      

		                                                                             
		                            
		                  
		             
		              
		                                   
		                                      

		              
		 
			                                                                                                                  

			                            
			                                                                             
			                            
			                                  
			 
				                                                       
				                                                 
				                                                                              
				                                                                    
			 

			                
			                                                  

			                                                                                                                       
			          

			                          
			 
				                                  
				 
					        
				 
				    
				 
					           
					                          
					 
						         
						        
					 
					    
					 
						                        
					 
				 
			 

			                   
				                                                                                                                   

			                       
			                        

			     
		 

		                           
	 

	                                           

                              
                                                                                                                   
                                                                                 
                                    
		                                           
 

                                                                
 
	                                                                       
	                                                                                                                         

	                                                                                                       

	                     
		            

	                       

	                                                                

	                                                 
		            

	           
 

                                                                                                               
 
	                                                                       
	                                                                                                                                

	                                                                      
		            

	                   
	 
		                                                                                                       

		                     
			            

		                       

		                                                                  

		                                                              
			            
	 

	           
 

                                                                                   
 
	                  
	                              
	                                                         
	                                                                   
	                                                              

	                                 

	                                       
	                                       

	              
		         

	         
 

                         
                                                                   
 
	                      

	                     
	                      
	                          
	                       

	                    
	 
		                            
		 
			            
			               
			                      
			 
				               
			 
		 

		                                                                            

		                                                                                      
		                                    
		                                                                                                                                                                          
		                                                                                                                     

		                     
		 
			                                    

			                                            
			 
				                                                                                                                 
				                   
			 
		 

		          
		           
	 

	           
 
                                   

                                                               
 
	                                   
 

                                                                               
 
	                                     
 

                                                         
 
	                                              
 

                                           
 
	                            
 

                                                    
 
	                                                  
	                                    
 

                    
                                                                                    
 
	                                           
		      

	                                                             
 
      

                                                                                          
 
	                                                      

	                                                          
	                      
	 
		                
		                                                                
			                                                         
	 
	                                                             
	                     
	 
		               
		                                                               
			                                                        
	 
 

                                  
                                                                 
 
                            

                                                                 

                         
                                                              

                            

                                        
  
                                                        
           

                                                                       
           

                                                          
                                                        
  

                              

                                  
                                                                                                               

                           
 

                                                                               
 
                              

             
                                              
   
                                          
   
  

         
 
      

                    
                                                                 
 
	                           

	                                                                

	                        
		                                                            

	                                              

	                                                                                                                                  

	                                                
	                                                           
	 
		                                                                  
		                               
		 
			                                         
			 
				                                     
				                                  
			 
			                                              
			 
				                                     
				                                  
			 
			                                              
			 
				                                     
				                                  
			 
			                                              
			 
				                                     
				                                  
			 
			                                              
			 
				                                     
				                                  
			 
			                                              
			 
				           
			 
			    
			 
				                                  
			 
			                                                                                       
		 
	 
 
      

                                                                                                                            
 

	                                                 
	                                                             
	                           
	                             
	                                         
	                       
	                                    
	                                 
	                 
	                     
	                               

	                                           
	                                                                         
	                                          
	                                                   
	                                         
	                                                                              

	                                                           
	                        
	 
		                                            
	 

	                                       
	                           

	                 
 

                                                                 
 
	                                                                                               
	 
		                                                             
		                                                      
		                              
		                                                                                       
		                                                                    
		                                                                                                                                                
		                                       
		                                                                                 

		                                          
		 
			                                                                                                                   
		 

		                                                  
	 

	                                    
 

                                                              
 
	                                                                     
		            

	                                                     
		           

	                                            
	                         
		           

	                                                   
 

                                                                 
 
	                                           
		      

	                                                                                      
	                                                                               

	                                       
 

                                                            
 
	                                           
		      

	                                                              

	                                                
	 
		                                                          
		                                                       
	 
	    
	 
		                                                         
		                                                 
	 
 

                                                      
 
	                                           
		      

	                                                             
	                                       
	                                    

	                                                                 
	                                   
		                                        
 

                                                         
 
	                                           
		      

	                                                                 
	                                   
	 
		                                                                                       
			                                                                     
	 
 

                                                                   
 
	                                    
		      

	                           

	                              
	                                                                                      
	                                                                  
	                                                                                                                                     
	                                       
	                                                                                 

	                                                                                 

	                             

	                                           

	                                           

	                                       
 

                                               
 
	                                         
	 
		                                          
		 
			             
		 
	 

	                                            

	                                      
		                                                                                         
 

                                  
 
	                                         
	 
		                            
			                    
	 
 

                                                
 
	                              
	                                
	                                   
	             
	                                       
	 
		                                                     

		                                    
		 
			                                                          
			 
				             
				                                     
				                                                   
				 
					                                                                                       
					 
						       
					 
				 

				                                        
				 
					                                   
					                              
					     
				 
				    
				 
					                                      
					                              
				 
			 
		 

		                                              
		                             
		 
			                                                  
			 
				                                                     
			 
		 
	 
	    
	 
		                                                      
		                                             
		                          
	 

	                                                            

	                            
	                                        
		                

	                          

	                                                              
	 
		                                                               
		 
			                                  
			                                 
		 
	 

	                                        

	                                        
	 
		                                        
		                         
		                             
		 
			                                             
			                                                   
				                            
		 

		                                     
		 
			                               
			                                       
		 

		                                   
	 

	                                        

	                                                        
 

                                                               
 
	                                     
	                          

	                                                        
	                            
	 
		                                               
			        
		                    
		     
	 

	                                                                                         

	                                        
	 
		                    
		 
			                                       
		 
		    
		 
			                                             
		 
	 
 

                                                            
 
	                                                                           
	 
		                              
			                      

		      
	 

	                   

	                                                            
	 
		                           
	 
	    
	 
		                                                                                                                                                
		                      
	 

	                                                      
	                                     

	                                                                               
	                                            
	                                            
	                                                  

	                            

	                                                               
	                                                                                        

	                                                                                                      

	                                                  
	                                                                             

	                                         
 


                                                                      
 
	                                             
 


                                                                                 
 
	                                                                     
	                                                                       

	                                                                 
	                                                  
	                                                                             

	                          
 

#endif         

#if CLIENT
void function SURVIVAL_AddCallback_OnDeathFieldStartShrink( void functionref( DeathFieldStageData ) callbackFunc )
{
	Assert( !file.ClientCallbacks_OnDeathFieldStartShrink.contains( callbackFunc ), "Already added " + string( callbackFunc ) + " with SURVIVAL_AddCallback_OnDeathFieldStartShrink" )
	file.ClientCallbacks_OnDeathFieldStartShrink.append( callbackFunc )
}

void function SURVIVAL_AddCallback_OnDeathFieldStopShrink( void functionref( DeathFieldStageData ) callbackFunc )
{
	Assert( !file.ClientCallbacks_OnDeathFieldStopShrink.contains( callbackFunc ), "Already added " + string( callbackFunc ) + " with SURVIVAL_AddCallback_OnDeathFieldStopShrink" )
	file.ClientCallbacks_OnDeathFieldStopShrink.append( callbackFunc )
}


void function UpdateSurveyBeaconHint()
{
	if ( GetCurrentPlaylistVarBool( "survey_beacons_enabled", true ) == false )
		return

	entity localClientPlayer = GetLocalClientPlayer()
	entity player = localClientPlayer.GetTeam() == TEAM_SPECTATOR ? localClientPlayer : GetLocalViewPlayer()
	if ( !PlayerShouldSeeSurveyBeaconMarkers( player ) )
		RemoveMapFeatureItemByName( "#SURVEY_BEACON" )
	else
		SetMapFeatureItem( 100, "#SURVEY_BEACON", "#SURVEY_BEACON_DESC", $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder" )
}


void function OnPropDynamicCreated( entity prop )
{
	string modelName = prop.GetModelName()
	if ( modelName == "mdl/fx/bb_shield.rmdl" )
	{
		Chroma_OnBubbleShieldCreated( prop )
	}
}

void function OnPropScriptCreated( entity prop )
{
	if ( prop.GetTargetName() == "surveyZone" )
	{
		file.surveyMinimapEnts.append( prop )
		AddEntityDestroyedCallback( prop, SurveyZoneCleanupOnDestroy )
	}

	if ( prop.GetTargetName() == "deathField" )
	{
		file.deathField = prop

		thread Cl_DeathFieldThink( prop )

		var gamestateRui = ClGameState_GetRui()
		array<var> ruis  = [gamestateRui]
		var cameraRui    = GetCameraCircleStatusRui()
		if ( IsValid( cameraRui ) )
			ruis.append( cameraRui )

		foreach ( rui in ruis )
		{
			RuiTrackFloat3( rui, "deathFieldOrigin", prop, RUI_TRACK_ABSORIGIN_FOLLOW )
		}
	}

	if ( (prop.GetTargetName() == "safeZone") || (prop.GetTargetName() == "safeZone_noline") )
	{
		file.safeZone = prop

		var gamestateRui = ClGameState_GetRui()
		array<var> ruis  = [gamestateRui]
		var cameraRui    = GetCameraCircleStatusRui()
		if ( IsValid( cameraRui ) )
			ruis.append( cameraRui )

		foreach ( rui in ruis )
		{
			RuiTrackFloat3( rui, "safeZoneOrigin", prop, RUI_TRACK_ABSORIGIN_FOLLOW )
		}
	}

	OnSurveyBeaconCreated( prop )
}

void function SurveyZoneCleanupOnDestroy( entity surveyZoneEnt )
{
	file.surveyMinimapEnts.fastremovebyvalue( surveyZoneEnt )
}

int function Cl_Deathfield_GetFXIDForRadius( float radius )
{
	array<int> fxIdx     = [ GetParticleSystemIndex( $"P_survival_radius_CP_1x1" ), GetParticleSystemIndex( $"P_survival_radius_CP_1x5" ), GetParticleSystemIndex( $"P_survival_radius_CP_1x100" ) ]

	if ( file.usePreciseRingFx )
		fxIdx     = [ GetParticleSystemIndex( $"P_survival_radius_CP_1k_x_1k" ), GetParticleSystemIndex( $"P_survival_radius_CP_1k_x_5k" ), GetParticleSystemIndex( $"P_survival_radius_CP_1k_x_100k" ) ]

	if ( file.ringOpacityOverrideEnabled )
		fxIdx     = [ GetParticleSystemIndex( $"P_ring_radCP1_opaCP2_1k_x_1k" ), GetParticleSystemIndex( $"P_ring_radCP1_opaCP2_1k_x_5k" ), GetParticleSystemIndex( $"P_ring_radCP1_opaCP2_1k_x_100k" ) ]

	int idealIdx
	if ( radius <= 3000 )
	{
		idealIdx = 2
	}
	else if ( radius <= 17000 )
	{
		idealIdx = 1
	}
	else
	{
		idealIdx = 0
	}

	return fxIdx[ idealIdx ]
}

void function Cl_DeathFieldThink( entity deathField )
{
	deathField.SetDoDestroyCallback( true )
	deathField.EndSignal( "OnDestroy" )

	int effectID = Cl_Deathfield_GetFXIDForRadius( 64000.0 )
	int ringFX   = StartParticleEffectOnEntity( deathField, effectID, FX_PATTACH_ABSORIGIN_FOLLOW, ATTACHMENTID_INVALID )

	table<string, int> e
	e["fx"] <- ringFX

	entity deathfieldSoundEnt = CreateClientsideScriptMover( $"mdl/dev/empty_model.rmdl", deathField.GetOrigin(), <0, 0, 0> )

	OnThreadEnd(
		function() : ( e, deathfieldSoundEnt )
		{
			deathfieldSoundEnt.Destroy()
			EffectStop( e["fx"], true, true )
		}
	)

	string currentSoundPlaying = ""
	bool wasMoving             = false

	int currentDeathFieldStage = -1
	float lastStartTime        = 0.0
	float lastEndTime          = 0.0

	bool playSoundInPrematch = GetCurrentPlaylistVarBool( "deathfield_play_sound_in_prematch", true )

	while ( 1 )
	{
		entity clientPlayer = GetLocalClientPlayer()
		if ( !file.trackingObserverDeathfield && clientPlayer.GetTeam() == TEAM_SPECTATOR && clientPlayer.GetObserverMode() == OBS_MODE_ROAMING )
		{
			TrackDeathfieldDistance( clientPlayer, clientPlayer )
			file.trackingObserverDeathfield = true
		}

		int dIndex 		= GetLocalViewPlayer().DeathFieldIndex()
		int stage       = SURVIVAL_GetCurrentDeathFieldStage()
		float startTime = GetGlobalNetTime( "nextCircleStartTime" ) + MARGIN_WAIT_TIME

		if ( currentDeathFieldStage != stage )
		{
			currentDeathFieldStage = stage
			foreach ( void functionref( int, float ) callback in file.onSurvivalDeathFieldStageChangedCallbacks )
				thread callback( currentDeathFieldStage, startTime )
		}

		float duration  = GetGlobalNetTime( "circleCloseTime" ) - startTime
		float unclampedFrac = -1
		float frac          = 0

		if ( Time() < startTime )
		{
			unclampedFrac = -1
			frac          = 0
		}
		else if ( duration != 0 )
		{
			unclampedFrac = (Time() - startTime) / duration
			frac          = clamp( unclampedFrac, 0.0, 1.0 )
		}

		float radius        = DeathField_GetRadiusForNow( dIndex )
		float radiusScale   = Cl_Deathfield_GetRadiusScale()

		DeathFieldStageData deathFieldData = file.deathFieldStageData[stage]
		deathFieldData.shrinkDuration = duration

		if ( Time() >= startTime && lastStartTime < startTime )
		{
			                                                             
			                                                    
			foreach ( void functionref( DeathFieldStageData ) callback in file.ClientCallbacks_OnDeathFieldStartShrink )
				callback( deathFieldData )

			lastStartTime = startTime
		}

		if ( Time() >= (startTime + duration) && (startTime + duration) != lastEndTime )
		{
			                                                            
			                                                   
			foreach ( void functionref( DeathFieldStageData ) callback in file.ClientCallbacks_OnDeathFieldStopShrink )
				callback( deathFieldData )

			lastEndTime = (startTime + duration)
		}

		int idealFx = Cl_Deathfield_GetFXIDForRadius( radius )
		if ( idealFx != effectID )
		{
			effectID = idealFx
			EffectStop( e["fx"], true, true )
			ringFX = StartParticleEffectOnEntity( deathField, effectID, FX_PATTACH_ABSORIGIN_FOLLOW, ATTACHMENTID_INVALID )
			e["fx"] = ringFX
		}

		entity player        = GetLocalViewPlayer()
		vector fwdToPlayer   = Normalize( <player.GetOrigin().x, player.GetOrigin().y, 0> - <deathField.GetOrigin().x, deathField.GetOrigin().y, 0> )
		vector circleEdgePos = deathField.GetOrigin() + (fwdToPlayer * radius)
		circleEdgePos.z = player.EyePosition().z

		if ( PositionIsInMapBounds( circleEdgePos ) )
		{
			deathfieldSoundEnt.SetOrigin( circleEdgePos )
			string soundToPlay = GetCircleSoundForSize( radius )

			bool moving = unclampedFrac == frac

			if ( moving )
				soundToPlay = soundToPlay + "_Movement"

			if ( !playSoundInPrematch && GetGameState() == eGameState.Prematch )
			{
				soundToPlay = ""
			}

			if ( (!moving || currentSoundPlaying == "" || wasMoving != moving) && currentSoundPlaying != soundToPlay )
			{
				if ( currentSoundPlaying != "" )
					StopSoundOnEntity( deathfieldSoundEnt, currentSoundPlaying )
				if ( soundToPlay != "" )
					EmitSoundOnEntity( deathfieldSoundEnt, soundToPlay )

				currentSoundPlaying = soundToPlay
				wasMoving = moving
			}
		}

		Minimap_SetDeathFieldRadius( radius )
		FullMap_SetDeathFieldRadius( radius )
		EffectSetControlPointVector( e["fx"], 1, <radius / radiusScale, 0, 0> )

		if ( file.ringOpacityOverrideEnabled )
			EffectSetControlPointVector( e["fx"], 2, < file.ringOpacityOverrideValue, 0, 0 > )

		WaitFrame()
	}
}

void function Cl_Deathfield_SetOpacityOverride( entity e, float newVal )
{
	file.ringOpacityOverrideValue = newVal
}

float function Cl_Deathfield_GetRadiusScale()
{
	return file.usePreciseRingFx ? 1000.0 : 1.0
}

string function GetCircleSoundForSize( float radius )
{
	foreach ( distance, sound in distanceToSound )
	{
		if ( distance < radius )
		{
			return sound
		}
	}

	return ""
}

void function ServerCallback_SurveyBeaconNotifications( entity beacon, int notificationNumber )
{
	switch ( notificationNumber )
	{
		case ePathfinderNotifications.TEAM_SUCCESS:
			                                               
			entity localViewPlayer = GetLocalViewPlayer()
			if ( IsValid( localViewPlayer ) && PlayerHasPassive( localViewPlayer, ePassives.PAS_PATHFINDER ) )
				AddPlayerHint( 2.5, 0.25, $"rui/hud/ultimate_icons/ultimate_pathfinder", "#SURVEY_PATHFINDER_SUCCESS" )

			clGlobal.levelEnt.Signal( "UpdateSurveyBeaconVisibility" )

			break

		case ePathfinderNotifications.NOT_PATHFINDER:
			AddPlayerHint( 1.25, 0.25, $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", "#SURVEY_NOT_PATHFINDER" )
			break

		case ePathfinderNotifications.ALREADY_ACTIVE:
			AddPlayerHint( 1.25, 0.25, $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", "#SURVEY_ALREADY_ACTIVE" )
			break

		case ePathfinderNotifications.ALREADY_USED:
			AddPlayerHint( 1.25, 0.25, $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", "#SURVEY_ALREADY_USED" )
			break
	}

	bool showSquadInfo =  GetCurrentPlaylistVarBool( "beacon_show_squad_info", false )
	if (showSquadInfo)
		SurveyBeacon_ShowSquadInfo()

}

void function SurveyBeacon_ShowSquadInfo()
{
	thread SurveyBeacon_ShowSquadInfo_Thread()
}

void function  SurveyBeacon_ShowSquadInfo_Thread()
{
	var gamestateRui = ClGameState_GetRui()
	float squadInfoShowtime = GetCurrentPlaylistVarFloat( "beacon_info_duration", 7.0 )
	RuiSetBool( gamestateRui, "isVisible", true )
	wait squadInfoShowtime
	RuiSetBool( gamestateRui, "isVisible", false )
}

void function OnSurveyBeaconCreated( entity beacon )
{
	if ( !IsValid( beacon ) )
		return

	if ( beacon.GetScriptName() == SURVEY_BEACON_SCRIPTNAME )
	{
		string modelName = beacon.GetModelName()
		if ( modelName == SURVEY_BEACON_MODEL )
		{
			CreateCallback_Panel( beacon )
			ClearCallback_CanUseEntityCallback( beacon )
			SetCallback_CanUseEntityCallback( beacon, SurveyBeacon_CanUseFunction )
		}

		thread BeaconIconThink( beacon )
	}
}

void function BeaconIconThink( entity beacon )
{
	beacon.EndSignal( "OnDestroy" )

	table<string, var> e
	e[ "rui" ] <- null

	OnThreadEnd(
		function() : ( e )
		{
			if ( e["rui"] != null )
				RuiDestroy( e ["rui"] )
		}
	)

	while ( IsValid( beacon ) )
	{
		bool shouldBeVisible = TeamShouldSeeBeaconMarker( GetLocalViewPlayer().GetTeam() )

		if ( shouldBeVisible )
		{
			if ( e[ "rui" ] == null )
	{
				var rui = SurveyBeacon_CreateHUDMarker( $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", beacon )
				e[ "rui" ] = rui
			}
		}
		else
		{
			if ( e[ "rui" ] != null )
			{
				RuiDestroy( e ["rui"] )
				e[ "rui" ] = null
			}
		}

		clGlobal.levelEnt.WaitSignal( "UpdateSurveyBeaconVisibility" )
	}
}

void function ServerCallback_UpdateSurveyBeaconHUDVisibility()
{
	clGlobal.levelEnt.Signal( "UpdateSurveyBeaconVisibility" )
}

void function SurveyBeaon_ClassChanged( entity player )
{
	clGlobal.levelEnt.Signal( "UpdateSurveyBeaconVisibility" )
}

void function OnViewPlayerChanged( entity viewPlayer )
{
	entity localClientPlayer = GetLocalClientPlayer()
	if( GameRules_GetGameMode() == SURVIVAL && localClientPlayer && localClientPlayer.GetTeam() == TEAM_SPECTATOR )
	{
		RuiSetBool( ClGameState_GetRui(), "hideDeathFieldWarning", ( localClientPlayer.GetObserverMode() == OBS_MODE_ROAMING ) )
	}
}

var function SurveyBeacon_CreateHUDMarker( asset beaconImage, entity minimapObj )
{
	entity localViewPlayer = GetLocalViewPlayer()
	vector pos             = minimapObj.GetOrigin() + (minimapObj.GetUpVector() * 96)
	var rui                = CreateFullscreenRui( $"ui/survey_beacon_marker_icon.rpak", RuiCalculateDistanceSortKey( localViewPlayer.EyePosition(), pos ) )
	RuiSetImage( rui, "beaconImage", beaconImage )
	RuiSetGameTime( rui, "startTime", Time() )
	RuiSetFloat3( rui, "pos", pos )
	RuiKeepSortKeyUpdated( rui, true, "pos" )
	return rui
}

#if DEV
void function DEV_OnDummyCircleWpInstanced( entity wp )
{
	float startTime = wp.GetWaypointFloat( 0 )
	float endTime = wp.GetWaypointFloat( 1 )
	float endRadius = float( wp.GetWaypointInt( 0 ) )

                       
                                                                     
       
}
#endif       
#endif          

int function SURVIVAL_GetCurrentDeathFieldStage()
{
	return GetGlobalNetInt( "currentDeathFieldStage" )
}


string function SURVIVAL_GetCurrentRoundString()
{
	int curStage = SURVIVAL_GetCurrentDeathFieldStage()

	                                                             
	                                        
	if ( SURVIVAL_IsFinalDeathFieldStage() )
		return FINAL_ROUND_ALIAS_SUFFIX
	else
		return string( curStage + 1 )

	unreachable
}


bool function SURVIVAL_IsFinalDeathFieldStage()
{
	int curStage = SURVIVAL_GetCurrentDeathFieldStage()

	return (curStage >= file.deathFieldStageData.len() - 1)
}


void function AddCallback_OnSurvivalDeathFieldStageChanged( void functionref( int stage, float nextCircleStartTime ) callback )
{
	Assert( !file.onSurvivalDeathFieldStageChangedCallbacks.contains( callback ), "Tried to add a callback that was already added" )

	file.onSurvivalDeathFieldStageChangedCallbacks.append( callback )
}


void function RemoveCallback_OnSurvivalDeathFieldStageChanged( void functionref( int stage, float nextCircleStartTime ) callback )
{
	Assert( file.onSurvivalDeathFieldStageChangedCallbacks.contains( callback ), "Tried to remove a callback that was not added" )

	file.onSurvivalDeathFieldStageChangedCallbacks.fastremovebyvalue( callback )
}


bool function SURVIVAL_DeathFieldIsValid( int realm )
{
	if ( realm in file.deathField )
		return IsValid( file.deathField[ realm ] )

	return false
}

#if SERVER
                                                                 
 
	                            
	                          
	                                                                   
 
#endif

bool function HasDeathFieldImmunity( entity player )
{
	return player.GetPlayerNetBool( "hasDeathFieldImmunity" )
}


#if SERVER
                                                         
 
	                                          
 
#endif

#if CLIENT
vector function Cl_SURVIVAL_GetDeathFieldCenter()
{
	if ( IsValid( file.deathField ) )
		return file.deathField.GetOrigin()
	else
		return <0, 0, 0>

	unreachable
}
#endif


#if CLIENT
float function Cl_SURVIVAL_GetDeathFieldCurrentRadius()
{
		float startRadius = SURVIVAL_Deathfield_GetStartRadius()

		int i = SURVIVAL_GetCurrentDeathFieldStage()

		if ( i == -1 )
			return startRadius

		float startTime = GetGlobalNetTime( "nextCircleStartTime" ) + MARGIN_WAIT_TIME
		DeathFieldStageData data = file.deathFieldStageData[i]
		if ( i > 0 )
		{
			DeathFieldStageData prevData = file.deathFieldStageData[i - 1]
			startRadius = prevData.endRadius
		}

		float duration = data.shrinkDuration
		float endRadius = data.endRadius

		float frac = (Time() - startTime) / duration
		frac = clamp( frac, 0.0, 1.0 )
		return startRadius + ((endRadius - startRadius) * frac)
}
#endif

#if SERVER
                                                               
 
		                                                 
 
#endif

             
                                                                
 
                                                   
  
            
                                                                                                                    
                 
              
  

            
 
      

                    
bool function SurveyBeacon_CanUseFunction( entity player, entity beacon, int useFlags )
{

	if ( GetGameState() < eGameState.Playing )
		return false

	if ( !PlayerShouldSeeSurveyBeaconMarkers( player ) )
	{
		#if CLIENT
			ShowSurveyBeaconTeamHint( player )
		#endif         

		return false
	}

	SurveyBeaconData data = file.surveyBeaconData[ player ]
	if ( data.canUseFunc != null )
	{
		if ( !data.canUseFunc( player, beacon ) )
		{
			return false
		}
	}

	if ( !ControlPanel_CanUseFunction( player, beacon, useFlags ) )
		return false

	return true
}

bool function Recon_CanUseBeacon( entity player, entity beacon )
{
	if ( HasActiveSurveyZone( player ) )
	{
		#if CLIENT
			AddPlayerHint( 0.1, 0, $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", "#SURVEY_ALREADY_ACTIVE" )
		#endif         
		return false
	}

	return true
}

#if CLIENT
entity function GetTeamSurveyBeaconUser( int team )
{
	array<entity> teamArray = GetPlayerArrayOfTeam_AliveConnected( team )
	foreach ( teamMember in teamArray )
	{
		if ( PlayerHasPassive( teamMember, ePassives.PAS_PATHFINDER ) )
			return teamMember
	}
	return null
}


void function ShowSurveyBeaconTeamHint( entity player )
{
	entity beaconUser = GetTeamSurveyBeaconUser( player.GetTeam() )
	if ( !IsValid( beaconUser ) )
		return

	if ( HasActiveSurveyZone( beaconUser ) )
		AddPlayerHint( 0.1, 0, $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", "#SURVEY_ALREADY_ACTIVE" )
	else
		AddPlayerHint( 0.1, 0, $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder", "#SURVEY_TEAM_MESSAGE" )
}
#endif         
                         

bool function HasActiveSurveyZone( entity player )
{
	foreach ( surveyZone in file.surveyMinimapEnts )
	{
		if ( surveyZone.GetOwner() == player )
		{
			return true
		}
	}
	return false
}

bool function TeamHasActiveSurveyZone( int team )
{
	foreach ( surveyZone in file.surveyMinimapEnts )
	{
		entity owner = surveyZone.GetOwner()
		if ( IsValid( owner ) && owner.GetTeam() == team )
		{
			return true
		}
	}
	return false
}

#if SERVER

                                                       
 
	                                              
 


                                                      
 
	                                             
 


                                                                
 
	                                                                                                             
 


                                                                      
 
	                                                                                                              
	               
 


                                                                               
 
	                                                                                                   
	           
 


                                                 
 
	                               
 

                                                   
 
	                                  
 

                                                     
 
	                                    
 
#endif         

#if CLIENT
void function TrackDeathfieldDistance( entity cockpit, entity player )
{
	thread TrackDeathfieldDistance_Internal( cockpit, player )
}


void function TrackDeathfieldDistance_Internal( entity cockpit, entity player )
{
	player.EndSignal( "OnDestroy" )
	cockpit.EndSignal( "OnDestroy" )

	bool wasShowingDeathFieldFx = false
	int screenFx

	OnThreadEnd(
		function() : ( screenFx, player )
		{
			                                             
			ColorCorrection_SetWeight( file.colorCorrection, 0.0 )
			Chroma_EnteredRing()

			if ( EffectDoesExist( file.fieldEffectHandle ) )
			{
				EffectStop( file.fieldEffectHandle, true, false )
			}

			if( file.trackingObserverDeathfield && player.GetTeam() == TEAM_SPECTATOR )
			{
				file.trackingObserverDeathfield = false
			}
		}
	)

	ColorCorrection_SetExclusive( file.colorCorrection, true )

	while ( 1 )
	{
		if ( player.GetTeam() == TEAM_SPECTATOR && player.GetObserverMode() != OBS_MODE_ROAMING )
			return                                

		bool shouldShowDeathFieldFx = ShouldShowDeathFieldEffects( player )                                                                                           

		if ( wasShowingDeathFieldFx != shouldShowDeathFieldFx )
		{
			if ( shouldShowDeathFieldFx )
			{
				Callback_OnPlayerEnteredDeathfield( player )

				if ( !EffectDoesExist( screenFx ) && player.GetTeam() != TEAM_SPECTATOR )                                                                                                          
				{
					screenFx = StartParticleEffectOnEntity( cockpit, GetParticleSystemIndex( DEATHFIELD_EFFECT ), FX_PATTACH_ABSORIGIN_FOLLOW, ATTACHMENTID_INVALID )
					file.fieldEffectHandle = screenFx

					EffectSetIsWithCockpit( screenFx, true )
				}

				ColorCorrection_SetWeight( file.colorCorrection, 1.0 )

				Chroma_LeftRing()
			}
			else
			{
				Callback_OnPlayerLeftDeathfield( player )

				if ( EffectDoesExist( screenFx ) )
				{
					EffectStop( screenFx, true, true )
				}

				ColorCorrection_SetWeight( file.colorCorrection, 0.0 )

				Chroma_EnteredRing()
			}
			wasShowingDeathFieldFx = shouldShowDeathFieldFx
		}

		WaitFrame()
	}
}


bool function ShouldShowDeathFieldEffects( entity player )
{
	bool shouldShow = true

	if ( player.GetTeam() != TEAM_SPECTATOR && !IsAlive( player ) )
		shouldShow = false

	if ( player.ContextAction_IsInVehicle() )
	{
		if ( DeathField_PointDistanceFromFrontier( player.EyePosition(), player.DeathFieldIndex() ) >= 0 )
			shouldShow = false

                                
                                                                         
                                                                                                         
                     
        
	}
	else
	{
		if ( DeathField_PointDistanceFromFrontier( player.GetOrigin(), player.DeathFieldIndex() ) >= 0 )
			shouldShow = false

                                
                                                                        
                                                                                                       
                     
        
	}

	if ( IsViewingSquadSummary() || IsViewingDeathRecap() )
		shouldShow = false

	if ( StatusEffect_GetSeverity( player, eStatusEffect.ring_immunity ) >= 1 )
		shouldShow = false

	                                                                                                                                                                       
	if ( HasDeathFieldImmunity( player ) )
		shouldShow = false

	return shouldShow
}


void function Callback_OnPlayerEnteredDeathfield( entity player )
{
	                                                                              
	printt( "Callback_OnPlayerEnteredDeathfield" )
}


void function Callback_OnPlayerLeftDeathfield( entity player )
{
	                                                                                              
	printt( "Callback_OnPlayerLeftDeathfield" )
}


void function Callback_OnPlayerTakeDeathFieldDamage( float damage, vector damageOrigin, int damageType, int damageSourceId, entity attacker )
{
	thread DisplayHolsterWeaponHint()
}


void function DisplayHolsterWeaponHint()
{
	const HINT_DURATION = 5.0
	const HINT_FADEOUT = 0.5
	const HINT_FIRST_DELAY = 3.0
	const HINT_INTERVAL_TIME = HINT_DURATION + 10.0

	if ( Time() - file.nextHolsterHintTime < HINT_INTERVAL_TIME )
		return

	entity viewPlayer   = GetLocalViewPlayer()
	entity activeWeapon = viewPlayer.GetActiveWeapon( eActiveInventorySlot.mainHand )
	if ( !IsValid( activeWeapon ) )
		return

	if ( activeWeapon.GetWeaponType() != WT_DEFAULT )
		return

	if ( activeWeapon == viewPlayer.GetNormalWeapon( WEAPON_INVENTORY_SLOT_PRIMARY_2 ) )
		return

	if ( DeathField_PointDistanceFromFrontier( viewPlayer.GetOrigin(), viewPlayer.DeathFieldIndex() ) > 0 )
		return

	if ( Bleedout_IsBleedingOut( viewPlayer ) )
		return

	AddPlayerHint( HINT_DURATION, HINT_FADEOUT, $"", "#HINT_HOLSTER_WEAPON" )
	file.nextHolsterHintTime = Time() + HINT_INTERVAL_TIME
}

#endif

#if SERVER
                                                   
 
	                               
 
#endif

             
                                                                                           
 
                                            
                                      
        

                         
  
               
   
                       
                                                                              
                                        
         

             
                                                          
                        
                                           
                                                                  
          
         
   
      
   
          
                                                         
      
                       
                                                    
         
   
  
 
      

                    
void function ReconClassCharacter_PassiveChanged( entity player, int passive, bool didHave, bool nowHas )
{
	if ( nowHas != didHave )
	{
		string calloutLine, player1pAnim, player3pAnim, panelAnim

		switch ( passive )
		{
			case ePassives.PAS_PATHFINDER:
			{
				calloutLine  = "bc_pathfinder_passive"
				player1pAnim = "pathfinder"
				player3pAnim = "pathfinder"
				panelAnim    = "pathfinder"
				break
			}
			case ePassives.PAS_VALK:
			{
				calloutLine  = "bc_surveyBeaconScanValkyrie"
				break
			}
			case ePassives.PAS_TRACKING_VISION:
			{
				calloutLine  = "bc_surveyBeaconScanBloodhound"
				break
			}
			case ePassives.PAS_CRYPTO:
			{
				if ( HasCryptoSword ( player ) )
				{
					calloutLine  = "bc_surveyBeaconScanCrypto"
					player1pAnim = "crypto"
					player3pAnim = "crypto"
				}
				else
				{
					calloutLine  = "bc_surveyBeaconScanCrypto"
					player3pAnim = "crypto"
				}
				break
			}
			case ePassives.PAS_PARIAH:
			{
				calloutLine  = "bc_surveyBeaconScanSeer"
				break
			}
               
			case ePassives.PAS_VANTAGE:
			{
				calloutLine  = "bc_surveyBeaconScanVantage"
				break
			}
      
			default:
				break
		}

		RegisterSurveyBeaconData( player, passive, nowHas, calloutLine, player1pAnim, player3pAnim, panelAnim )
	}
}

bool function HasCryptoSword( entity player )
{

	string meleeSkinName

	#if SERVER
		                                                     
	#elseif CLIENT
		entity meleeWeapon = player.GetNormalWeapon( WEAPON_INVENTORY_SLOT_PRIMARY_2 )
		if ( meleeWeapon != null )
			meleeSkinName = meleeWeapon.GetWeaponClassName()
	#endif

	printt ("IsCryptoSword() " + meleeSkinName)

	if ( meleeSkinName == "mp_weapon_crypto_heirloom_primary" )
		return true

	return false
}

void function RegisterSurveyBeaconData( entity player, int passive, bool nowHas, string calloutLine, string player1pAnim, string player3pAnim, string panelAnim )
{
	if ( nowHas )
	{
		SurveyBeaconData data = SurveyBeacon_RegisterPlayer( player, passive, calloutLine )
		data.canUseFunc = Recon_CanUseBeacon

		#if SERVER
			                                      
			                                                                      
		#endif
	}
	else
	{
		SurveyBeacon_DeregisterPlayer( player, passive )
	}
}


#if SERVER
                                                                                                                   
 
	                         
		                   

	                         
		                      

	                      
		                

	                                                                          
	                                                                        
	                                                                        

	                                                                  
	                                                                
	                                                                

	                                                                           
	                                                                         
	                                                                         
 
#endif

void function SurveyBeacon_DeregisterPlayer( entity player, int passive )
{
	if ( !( player in file.surveyBeaconData ) )
		return

	if ( file.surveyBeaconData[ player ].passiveSource == passive )
		delete file.surveyBeaconData[ player ]
}

SurveyBeaconData function SurveyBeacon_RegisterPlayer( entity player, int passive, string calloutLine = "" )
{
	SurveyBeaconData data
	data.calloutLine = calloutLine
	data.passiveSource = passive

	file.surveyBeaconData[ player ] <- data

	return data
}
      

#if CLIENT
entity function Cl_SURVIVAL_GetDeathField()
{
	return file.deathField
}

DeathFieldStageData function Cl_GetDeathFieldStage( int index )
{
	return file.deathFieldStageData[ index ]
}
#endif

int function Survival_GetNumDeathfieldStages()
{
	return file.deathFieldStageData.len()
}

                    
#if SERVER
                                                                                        
 
	                                           
		            

	 
		                                                                                           
		                                                                                         
		                                                                                       

		                                                                                           
		                                                                                         
		                                                                                       

		                                                                                         
		                                                                                       
		                                                                                     
	 

	           
 
#endif
      

#if CLIENT
void function MinimapPackage_SurveyBeacon( entity ent, var rui )
{
	RuiSetImage( rui, "defaultIcon", $"rui/hud/gametype_icons/survival/survey_beacon_only_pathfinder" )
	RuiSetImage( rui, "clampedDefaultIcon", $"" )
	RuiSetBool( rui, "useTeamColor", false )
}

void function FullmapPackage_SurveyBeacon( entity ent, var rui )
{
	MinimapPackage_SurveyBeacon( ent, rui )
	RuiSetFloat2( rui, "iconScale", <1.5,1.5,0.0> )
	RuiSetFloat3( rui, "iconColor", <0.5,0.5,0.5> )
}
#endif